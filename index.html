<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>101 æ”€çˆ¬è€… | AI Studio å®Œæ•´é‚„åŸç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; margin: 0; overflow: hidden; font-family: sans-serif; }
        #game-container { position: relative; width: 100%; max-width: 400px; height: 100vh; margin: 0 auto; background: #0f172a; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        .font-mono { font-family: 'Courier New', Courier, monospace; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui" class="absolute top-4 left-4 z-10 hidden pointer-events-none">
        <div class="bg-slate-900/80 backdrop-blur-md p-4 rounded-xl border border-teal-800/50 w-64 shadow-2xl text-white">
            <div class="flex justify-between items-end mb-1">
                <span class="text-xs font-bold text-teal-400">é«˜åº¦</span>
                <span class="text-2xl font-black"><span id="floor">0</span> <span class="text-sm font-normal text-teal-600">/ 101 F</span></span>
            </div>
            <div id="timer" class="text-right text-xs font-mono text-teal-400 mb-2 italic">00m00s00</div>
            <div class="space-y-3">
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-bold text-teal-500"><span>STAMINA</span><span id="stamina-text">100 / 100</span></div>
                    <div class="w-full bg-slate-950 rounded-full h-3 border border-teal-900/50 overflow-hidden"><div id="stamina-bar" class="h-full bg-sky-500" style="width: 100%"></div></div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-bold text-slate-400"><span>CHALK</span><span id="chalk-text">100%</span></div>
                    <div class="w-full bg-slate-950 rounded-full h-2 border border-slate-800 overflow-hidden"><div id="chalk-bar" class="h-full bg-slate-200" style="width: 100%"></div></div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-950/95 z-20 p-8 text-center text-white">
        <div id="start-screen">
            <div class="text-6xl mb-6">ğŸ§—</div>
            <h1 class="text-4xl font-black mb-10 italic bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-sky-500">101 CLIMBERS</h1>
            <button onclick="startGame()" class="bg-orange-500 hover:bg-orange-400 text-white px-16 py-5 rounded-2xl font-black text-2xl shadow-xl">é–‹å§‹æ”€ç™»</button>
        </div>
    </div>
</div>

<script>
/** æ ¸å¿ƒå¸¸æ•¸ (å®Œå…¨é‚„åŸ constants.ts) **/
const COLORS = { SKY_BOTTOM: '#0f172a', SKY_TOP: '#020617', BUILDING: '#1e293b', GLASS: '#115e59', MULLION: '#334155', PLAYER: '#38bdf8', GRIP: '#fbbf24', REST: '#22c55e', ITEM_BG: '#1e293b', BORDER_CHALK: '#94a3b8', BORDER_PINEAPPLE: '#fbbf24', WIND: 'rgba(255, 255, 255, 0.25)' };
const SETTINGS = { floorHeight: 400, buildingWidth: 400, staminaDrainRate: 0.15, staminaRecoverRate: 0.5, gravity: 0.28, jumpBasePower: 8.5, maxChalk: 100, chalkDrainRate: 0.12, climbSpeed: 4.0, walkSpeed: 4.8, airControl: 0.22, maxCharge: 60 };
const KEY_CONTROLS = { UP: ['arrowup','w'], DOWN: ['arrowdown','s'], LEFT: ['arrowleft','a'], RIGHT: ['arrowright','d'], GRAB: ['z'], JUMP: ['x'], CHARGE: [' '] };

/** è®Šæ•¸ç‹€æ…‹ **/
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
let active = false, startTime = 0, cameraY = 0;
let player = { x: 188, y: 80, vx: 0, vy: 0, w: 24, h: 32, stamina: 100, maxS: 100, chalk: 100, isHolding: false, grabLock: false, charge: 0 };
let grips = [], items = [], worldTexts = [], windParticles = [], keys = {}, prevKeys = {};

/** é—œå¡ç”Ÿæˆ (1:1 é‚„åŸ generateLevel) **/
function generateLevel() {
    grips = []; items = []; worldTexts = [];
    let curY = 0, lastX = 200, normalGripCount = 0;
    const addGrip = (x, y, w, h, type) => {
        if (grips.some(g => Math.abs(g.y - y) < 40 && Math.abs(g.x - x) < 30)) return false;
        grips.push({ x, y, width: w, height: h, type });
        lastX = x + w / 2; return true;
    };
    const getNextX = (w, dev, y) => {
        const minX = Math.max(50, lastX - dev - w/2), maxX = Math.min(350 - w, lastX + dev - w/2);
        return minX + Math.random() * (maxX - minX);
    };

    addGrip(0, 0, 400, 60, 'REST'); 
    worldTexts.push({ x: 20, y: 420, text: "1F: ä½¿ç”¨Xè·³èº / æ–¹å‘éµç§»å‹•", size: 14, color: "#fff" });
    worldTexts.push({ x: 20, y: 1220, text: "3F: ç¶ è‰²å€å¡Šå¯ç«™ç«‹æ¢å¾©é«”åŠ›", size: 14, color: "#fff" });
    worldTexts.push({ x: 20, y: 2020, text: "5F: æŒ‰ä½ Z éµå¯æŠ“æ¡é»ƒè‰²è‰²å¡Š", size: 14, color: "#fff" });

    curY = 120;
    // é‡é»ä¿®å¾©ï¼šé‚„åŸ 101 å±¤æ¨“å®Œæ•´ç”Ÿæˆå¾ªç’°
    while(curY < 101 * 400) {
        let type = (curY < 5*400) ? 'REST' : (normalGripCount >= 3 ? 'REST' : 'NORMAL');
        normalGripCount = (type === 'REST') ? 0 : normalGripCount + 1;
        let w = type === 'REST' ? 120 + Math.random()*60 : 40 + Math.random()*20; // ä¿®æ­£é»ƒè‰²å¯¬åº¦
        let h = type === 'REST' ? 24 : 140;
        if (addGrip(getNextX(w, 150, curY), curY, w, h, type)) {
            curY += (type === 'REST' ? 130 : 160);
            if (Math.random() > 0.8) items.push({ x: lastX-22, y: curY-50, w: 44, h: 44, type: Math.random()>0.5?'PINEAPPLE':'CHALK', active: true });
        } else curY += 40;
    }
}

/** æ ¸å¿ƒç‰©ç†é‚è¼¯ (é‚„åŸ update) **/
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => {
    if (e.key === ' ' && player.charge > 5) executeJump(player.charge);
    keys[e.key.toLowerCase()] = false;
};

function executeJump(c) {
    const power = SETTINGS.jumpBasePower * (1 + (c / SETTINGS.maxCharge) * 1.1);
    player.vy = power; player.vx += (keys['a']||keys['arrowleft']?-4.5:keys['d']||keys['arrowright']?4.5:0);
    player.charge = 0; player.isHolding = false; if(keys['z']) player.grabLock = true;
}

function startGame() {
    active = true; generateLevel(); startTime = Date.now();
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('ui').classList.remove('hidden');
    loop();
}

function loop() {
    if (!active) return;
    canvas.width = 400; canvas.height = window.innerHeight;

    let standingOn = grips.find(g => g.type === 'REST' && player.y <= g.y + g.height && player.y >= g.y + g.height - 15 && player.x + player.w > g.x && player.x < g.x + g.width && player.vy <= 0);
    let currentGrip = grips.find(g => player.x + player.w > g.x && player.x < g.x + g.width && player.y + player.h > g.y && player.y < g.y + g.height);

    if (!keys['z']) player.grabLock = false;

    if (keys['z'] && currentGrip && !player.grabLock && player.stamina > 0) {
        player.isHolding = true; player.vy = 0; player.vx = 0;
        player.stamina -= SETTINGS.staminaDrainRate; player.chalk = Math.max(0, player.chalk - SETTINGS.chalkDrainRate);
        if (keys['w']||keys['arrowup']) player.y += SETTINGS.climbSpeed;
        if (keys['s']||keys['arrowdown']) player.y -= SETTINGS.climbSpeed;
        if (keys['a']||keys['arrowleft']) player.x -= SETTINGS.climbSpeed;
        if (keys['d']||keys['arrowright']) player.x += SETTINGS.climbSpeed;
    } else if (standingOn) {
        player.isHolding = false; player.vy = 0; player.y = standingOn.y + standingOn.height;
        player.stamina = Math.min(player.maxS, player.stamina + SETTINGS.staminaRecoverRate);
        if (keys['a']||keys['arrowleft']) player.x -= SETTINGS.walkSpeed;
        if (keys['d']||keys['arrowright']) player.x += SETTINGS.walkSpeed;
        if (keys['x'] && !prevKeys['x']) executeJump(0);
    } else {
        player.isHolding = false; player.vy -= SETTINGS.gravity; player.y += player.vy; player.x += player.vx;
        if (keys['a']||keys['arrowleft']) player.vx -= SETTINGS.airControl;
        if (keys['d']||keys['arrowright']) player.vx += SETTINGS.airControl;
        player.vx *= 0.97;
    }

    if (keys[' ']) player.charge = Math.min(SETTINGS.maxCharge, player.charge + 1.5);

    // é“å…·ç¢°æ’
    items.forEach(it => {
        if (it.active && player.x < it.x + it.w && player.x + player.w > it.x && player.y < it.y + it.h && player.y + player.h > it.y) {
            it.active = false;
            if (it.type === 'PINEAPPLE') player.stamina = Math.min(player.maxS, player.stamina + 45);
            else player.chalk = Math.min(100, player.chalk + 40);
        }
    });

    // HUD æ›´æ–°
    const ms = Date.now() - startTime;
    document.getElementById('timer').innerText = `${String(Math.floor(ms/60000)).padStart(2,'0')}m${String(Math.floor((ms%60000)/1000)).padStart(2,'0')}s${String(Math.floor((ms%1000)/10)).padStart(2,'0')}`;
    document.getElementById('stamina-bar').style.width = (player.stamina/player.maxS*100) + '%';
    document.getElementById('chalk-bar').style.width = player.chalk + '%';
    document.getElementById('floor').innerText = Math.floor(player.y / 400);

    render();
    prevKeys = {...keys};
    cameraY += (player.y - 320 - cameraY) * 0.12;
    requestAnimationFrame(loop);
}

/** æ¸²æŸ“ç³»çµ± (é‚„åŸ render) **/
function render() {
    ctx.fillStyle = COLORS.SKY_TOP; ctx.fillRect(0,0,400,window.innerHeight);
    ctx.save(); ctx.translate(0, window.innerHeight); ctx.scale(1, -1); ctx.translate(0, -cameraY);

    // èƒŒæ™¯æ©«æ¢ (å¤§æ¨“ç´°ç¯€)
    ctx.strokeStyle = COLORS.MULLION; ctx.globalAlpha = 0.3;
    for (let y = Math.floor(cameraY/40)*40; y < cameraY + window.innerHeight + 40; y += 40) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(400, y); ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // æ–‡å­—èªªæ˜
    worldTexts.forEach(t => {
        ctx.save(); ctx.scale(1, -1); ctx.fillStyle = t.color; ctx.font = `bold ${t.size}px Arial`; ctx.fillText(t.text, t.x, -t.y); ctx.restore();
    });

    // è¸æ¿
    grips.forEach(g => { ctx.fillStyle = g.type === 'REST' ? COLORS.REST : COLORS.GRIP; ctx.fillRect(g.x, g.y, g.width, g.height); });

    // é“å…·
    items.forEach(it => {
        if (it.active) {
            ctx.fillStyle = COLORS.ITEM_BG; ctx.fillRect(it.x, it.y, it.w, it.h);
            ctx.save(); ctx.scale(1, -1); ctx.textAlign = 'center'; ctx.font = '24px Arial'; ctx.fillText(it.type==='PINEAPPLE'?'ğŸ':'ğŸ¥¡', it.x + 22, -it.y - 12); ctx.restore();
        }
    });

    // ç©å®¶æ–¹å¡Šå£“ç¸®èˆ‡è“„åŠ›æ¢
    const squash = player.charge / SETTINGS.maxCharge;
    const dW = player.w * (1 + squash * 0.3), dH = player.h * (1 - squash * 0.4);
    
    // è“„åŠ›å¤–æ¡†èˆ‡å…‰æ•ˆ
    if (player.charge > 5) {
        ctx.strokeStyle = player.charge >= SETTINGS.maxCharge ? '#ef4444' : '#fff';
        ctx.lineWidth = 2; ctx.strokeRect(player.x - (dW-player.w)/2 - 4, player.y - 4, dW + 8, dH + 8);
        ctx.fillStyle = player.charge >= SETTINGS.maxCharge ? '#ef4444' : '#fff';
        ctx.fillRect(player.x, player.y - 18, (player.w * squash), 6);
    }

    ctx.fillStyle = COLORS.PLAYER; ctx.fillRect(player.x - (dW-player.w)/2, player.y, dW, dH);
    ctx.restore();
}
</script>
</body>
</html>
