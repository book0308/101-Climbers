<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>101 æ”€çˆ¬è€… | å®Œæ•´æ•™å­¸èˆ‡é—œå¡ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; margin: 0; overflow: hidden; font-family: sans-serif; }
        #game-container { position: relative; width: 100%; max-width: 400px; height: 100vh; margin: 0 auto; background: #0f172a; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui" class="absolute top-4 left-4 z-10 hidden pointer-events-none">
        <div class="bg-slate-900/80 backdrop-blur-md p-4 rounded-xl border border-teal-800/50 w-64 shadow-2xl">
            <div class="flex justify-between items-end mb-1">
                <span class="text-xs font-bold text-teal-400 tracking-widest uppercase">é«˜åº¦</span>
                <span class="text-2xl font-black text-white"><span id="floor">0</span> <span class="text-sm font-normal text-teal-600">/ 101 F</span></span>
            </div>
            <div class="mt-4 space-y-3">
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-bold text-teal-500"><span>STAMINA</span><span id="stamina-text">100 / 100</span></div>
                    <div class="w-full bg-slate-950 rounded-full h-3 border border-teal-900/50 overflow-hidden"><div id="stamina-bar" class="h-full bg-sky-500" style="width: 100%"></div></div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-bold text-slate-400"><span>CHALK</span><span id="chalk-text">100%</span></div>
                    <div class="w-full bg-slate-950 rounded-full h-2 border border-slate-800 overflow-hidden"><div id="chalk-bar" class="h-full bg-slate-200" style="width: 100%"></div></div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-950/95 z-20 p-8 text-center">
        <div id="start-screen">
            <div class="text-6xl mb-6">ğŸ§—</div>
            <h1 class="text-5xl font-black mb-4 italic text-transparent bg-clip-text bg-gradient-to-br from-teal-300 to-sky-500">101 CLIMBERS</h1>
            <p class="text-slate-400 mb-10 text-sm leading-relaxed">ç®¡ç†é«”åŠ›ã€å°æŠ—å¼·é¢¨<br>å¾æœ 101 å±¤å·”å³°</p>
            <button onclick="startGame()" class="bg-orange-500 hover:bg-orange-400 text-white px-16 py-5 rounded-2xl font-black text-2xl shadow-xl">é–‹å§‹æ”€ç™»</button>
        </div>
        <div id="end-screen" class="hidden">
            <h2 id="result-title" class="text-5xl font-black mb-8"></h2>
            <button onclick="location.reload()" class="bg-teal-600 text-white px-12 py-4 rounded-xl font-bold shadow-lg">é‡æ–°æŒ‘æˆ°</button>
        </div>
    </div>
</div>

<script>
/** éŠæˆ²æ ¸å¿ƒé…ç½® **/
const COLORS = { SKY_BOTTOM: '#0f172a', SKY_TOP: '#020617', BUILDING: '#1e293b', GLASS: '#115e59', MULLION: '#334155', PLAYER: '#38bdf8', GRIP: '#fbbf24', REST: '#22c55e' };
const SETTINGS = { floorHeight: 400, totalFloors: 101, buildingWidth: 400, staminaDrainRate: 0.15, staminaRecoverRate: 0.5, gravity: 0.28, jumpBasePower: 8.5, maxChalk: 100, chalkDrainRate: 0.12 };

const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
let gameActive = false, stamina = 100, chalk = 100, floor = 0, cameraY = 0;
let player = { x: 200, y: 50, vx: 0, vy: 0, isHolding: false };
let grips = [], items = [], worldTexts = [];
let keys = {};

/** é—œå¡ç”Ÿæˆé‚è¼¯ (é‚„åŸ generateLevel) **/
const getBuildingWidthAtY = (y) => {
    const f = y / SETTINGS.floorHeight;
    return f < 90 ? SETTINGS.buildingWidth : SETTINGS.buildingWidth * (1 - (Math.min(1, (f - 90) / 11)) * 0.7);
};

function generateLevel() {
    grips = []; items = []; worldTexts = [];
    let curY = 0, lastX = 200, normalGripCount = 0;

    const addGrip = (x, y, w, h, type, extra = {}) => {
        if (grips.some(g => Math.abs(g.y - y) < 40 && Math.abs(g.x - x) < 30)) return false;
        grips.push({ x, y, width: w, height: h, type, ...extra });
        lastX = x + w / 2; return true;
    };

    const getNextX = (w, dev, y) => {
        const bW = getBuildingWidthAtY(y), centerX = 200;
        const minX = Math.max(centerX - bW/2 + 30, lastX - dev - w/2);
        const maxX = Math.min(centerX + bW/2 - w - 30, lastX + dev - w/2);
        return minX + Math.random() * (maxX - minX);
    };

    // åˆå§‹åœ°æ¿èˆ‡æ•™å­¸
    addGrip(0, 0, 400, 60, 'REST'); 
    worldTexts.push({ x: 40, y: 1 * 400 + 40, text: "1F: ä½¿ç”¨æ–¹å‘éµç§»å‹•" });
    worldTexts.push({ x: 40, y: 3 * 400 + 40, text: "3F: ç¶ è‰²å€å¡Šå¯ç«™ç«‹æ¢å¾©é«”åŠ›" });
    worldTexts.push({ x: 40, y: 5 * 400 + 40, text: "5F: æŒ‰ä½ Z éµå¯æŠ“æ¡é»ƒè‰²è‰²å¡Š" });

    curY = 120;
    while(curY < 30 * 400) {
        let type = (normalGripCount >= 3) ? 'REST' : 'NORMAL';
        normalGripCount = (type === 'REST') ? 0 : normalGripCount + 1;
        let w = type === 'REST' ? 120 + Math.random()*60 : 60 + Math.random()*40;
        let h = type === 'REST' ? 24 : 140;
        if (addGrip(getNextX(w, 150, curY), curY, w, h, type)) curY += (type === 'REST' ? 140 : 120);
        else curY += 40;
    }
}

/** éŠæˆ²ä¸»å¾ªç’° **/
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

function startGame() {
    gameActive = true; generateLevel();
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('ui').classList.remove('hidden');
    canvas.width = 400; canvas.height = window.innerHeight;
    player.y = 80; cameraY = 0; stamina = 100; chalk = 100;
    loop();
}

function loop() {
    if (!gameActive) return;

    // ç‰©ç†èˆ‡æ“ä½œ
    let standingOn = grips.find(g => g.type === 'REST' && player.y >= g.y + g.height && player.y <= g.y + g.height + 10 && player.x + 12 > g.x && player.x - 12 < g.x + g.width);
    let currentGrip = grips.find(g => player.x + 12 > g.x && player.x - 12 < g.x + g.width && player.y + 32 > g.y && player.y < g.y + g.height);

    if (keys['z'] && currentGrip && stamina > 0) {
        player.isHolding = true; player.vy = 0;
        stamina -= SETTINGS.staminaDrainRate;
        chalk = Math.max(0, chalk - SETTINGS.chalkDrainRate);
        if (keys['w']) player.y += 4; if (keys['s']) player.y -= 4;
    } else if (standingOn) {
        player.isHolding = false; player.vy = 0; player.y = standingOn.y + standingOn.height;
        stamina = Math.min(100, stamina + SETTINGS.staminaRecoverRate);
        if (keys['a']) player.x -= 4; if (keys['d']) player.x += 4;
    } else {
        player.isHolding = false; player.vy -= SETTINGS.gravity; player.y += player.vy;
        if (keys['a']) player.x -= 2; if (keys['d']) player.x += 2;
    }

    // æ›´æ–° HUD
    floor = Math.floor(player.y / 400);
    document.getElementById('floor').innerText = floor;
    document.getElementById('stamina-bar').style.width = stamina + '%';
    document.getElementById('chalk-bar').style.width = chalk + '%';

    draw();

    if (stamina <= 0 || player.y < cameraY - 100) endGame("åŠ›ç«­å¢œè½");
    if (floor >= 101) endGame("ç™»é ‚æˆåŠŸ", true);

    cameraY += (player.y - 300 - cameraY) * 0.1;
    requestAnimationFrame(loop);
}

function draw() {
    ctx.fillStyle = COLORS.SKY_TOP; ctx.fillRect(0,0,400,canvas.height);
    ctx.save(); ctx.translate(0, canvas.height); ctx.scale(1, -1); ctx.translate(0, -cameraY);

    // å¤§æ¨“èƒŒæ™¯
    ctx.fillStyle = COLORS.GLASS; ctx.globalAlpha = 0.3; ctx.fillRect(0, cameraY, 400, canvas.height + 500);
    ctx.strokeStyle = COLORS.MULLION; ctx.globalAlpha = 1;
    for(let y=0; y < 101*400; y+=40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(400, y); ctx.stroke(); }

    // æ•™å­¸æ–‡å­—
    worldTexts.forEach(t => { if(t.y > cameraY && t.y < cameraY + 800) { ctx.save(); ctx.scale(1,-1); ctx.fillStyle="#fff"; ctx.font="14px Arial"; ctx.fillText(t.text, t.x, -t.y); ctx.restore(); }});

    // æŠ“é»èˆ‡å¹³å°
    grips.forEach(g => {
        ctx.fillStyle = g.type === 'REST' ? COLORS.REST : COLORS.GRIP;
        ctx.fillRect(g.x, g.y, g.width, g.height);
    });

    // ä¸»è§’
    ctx.fillStyle = COLORS.PLAYER; ctx.fillRect(player.x-12, player.y, 24, 32);
    ctx.restore();
}

function endGame(msg, win) {
    gameActive = false;
    document.getElementById('overlay').classList.remove('hidden');
    document.getElementById('result-title').innerText = msg;
    document.getElementById('result-title').style.color = win ? COLORS.REST : '#ef4444';
}
</script>
</body>
</html>
