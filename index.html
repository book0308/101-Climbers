<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>101 æ”€çˆ¬è€… | Pro æœ€çµ‚ä¿®æ­£ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; margin: 0; overflow: hidden; font-family: 'Courier New', Courier, monospace; touch-action: none; }
        #game-container { position: relative; width: 100%; max-width: 480px; height: 100vh; margin: 0 auto; background: #0f172a; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui" class="absolute top-0 left-0 w-full p-4 pointer-events-none z-10 hidden transition-opacity duration-300">
        <div class="bg-slate-900/80 backdrop-blur-sm border border-slate-700/50 rounded-xl p-4 shadow-xl text-white">
            <div class="flex justify-between items-end mb-2">
                <div>
                    <div class="text-[10px] text-teal-500 font-bold tracking-widest uppercase">ç›®å‰é«˜åº¦</div>
                    <div class="text-3xl font-black leading-none"><span id="floor-display">0</span><span class="text-sm text-slate-500 ml-1">/ 101F</span></div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-teal-500 font-bold tracking-widest uppercase">ç¶“éæ™‚é–“</div>
                    <div id="timer-display" class="text-xl font-mono text-teal-300 leading-none">00:00:00</div>
                </div>
            </div>
            <div class="space-y-3 mt-2">
                <div>
                    <div class="flex justify-between text-[10px] font-bold mb-1">
                        <span class="text-sky-400">é«”åŠ› (STAMINA)</span>
                        <span id="stamina-val" class="text-slate-400">100 / 100</span>
                    </div>
                    <div class="w-full bg-slate-950 h-3 rounded-full overflow-hidden border border-slate-800">
                        <div id="stamina-bar" class="h-full bg-gradient-to-r from-sky-600 to-sky-400 transition-all duration-100" style="width: 100%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-[10px] font-bold mb-1">
                        <span class="text-slate-400">æ­¢æ»‘ç²‰ (CHALK)</span>
                        <span id="chalk-val" class="text-slate-500">100%</span>
                    </div>
                    <div class="w-full bg-slate-950 h-1.5 rounded-full overflow-hidden border border-slate-800">
                        <div id="chalk-bar" class="h-full bg-slate-400 transition-all duration-100" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="overlay" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-slate-950/95 p-6 text-center">
        <div id="start-screen" class="space-y-8 animate-fade-in">
            <div class="text-8xl mb-4 animate-bounce">ğŸ§—</div>
            <div>
                <h1 class="text-5xl font-black italic text-transparent bg-clip-text bg-gradient-to-br from-teal-300 to-sky-600 mb-2">101 CLIMBERS</h1>
                <p class="text-slate-400 text-xs tracking-[0.2em] uppercase">å°åŒ—å¤©éš›ç·šæŒ‘æˆ°</p>
            </div>
            <div class="grid grid-cols-2 gap-3 text-left bg-slate-900/50 p-6 rounded-2xl border border-slate-800 text-sm text-slate-300">
                <div class="flex items-center gap-2"><span class="bg-slate-700 px-2 py-1 rounded text-xs font-bold text-white">Z</span> æŠ“æ¡ (Hold)</div>
                <div class="flex items-center gap-2"><span class="bg-slate-700 px-2 py-1 rounded text-xs font-bold text-white">X</span> è·³èº (Jump)</div>
                <div class="flex items-center gap-2 col-span-2"><span class="bg-slate-700 px-2 py-1 rounded text-xs font-bold text-white">SPACE</span> è“„åŠ› (Charge)</div>
                <div class="col-span-2 text-xs text-orange-400 mt-2 border-t border-slate-800 pt-2 text-center">éœæ­¢ä¼‘æ¯ 2 ç§’å¯åŠ é€Ÿæ¢å¾©é«”åŠ›</div>
            </div>
            <button onclick="Game.start()" class="w-full px-8 py-4 bg-teal-600 hover:bg-teal-500 text-white font-black text-xl rounded-xl transition-all shadow-[0_0_20px_rgba(20,184,166,0.3)] hover:scale-105">é–‹å§‹æ”€ç™»</button>
        </div>

        <div id="end-screen" class="hidden space-y-6">
            <h2 id="end-title" class="text-4xl font-black text-white"></h2>
            <div class="bg-slate-900 p-6 rounded-xl border border-slate-800 space-y-2">
                <div class="text-slate-400 text-sm">æœ€çµ‚é«˜åº¦</div>
                <div class="text-3xl font-bold text-teal-400"><span id="end-floor">0</span> F</div>
                <div class="text-slate-400 text-sm mt-4">èŠ±è²»æ™‚é–“</div>
                <div id="end-time" class="text-xl font-mono text-white">00:00:00</div>
            </div>
            <button onclick="location.reload()" class="px-8 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg w-full transition-colors">å†æ¬¡æŒ‘æˆ°</button>
        </div>
    </div>
</div>

<script>
// --- Constants ---
const CONSTANTS = {
    COLORS: {
        SKY_TOP: '#020617', SKY_BOTTOM: '#0f172a',
        BUILDING: '#1e293b', GLASS: '#115e59', MULLION: '#334155',
        PLAYER: '#38bdf8', PLAYER_CHARGE: '#ffffff', PLAYER_MAX_CHARGE: '#ef4444',
        GRIP_NORMAL: '#fbbf24', GRIP_REST: '#22c55e',
        ITEM_BG: '#1e293b', BORDER_PINEAPPLE: '#fbbf24', BORDER_CHALK: '#94a3b8',
        WIND: 'rgba(255, 255, 255, 0.3)', REST_GLOW: '#4ade80'
    },
    SETTINGS: {
        floorHeight: 400, buildingWidth: 400,
        gravity: 0.28, friction: 0.85, airResistance: 0.97,
        moveSpeed: 4.8, climbSpeed: 4.0, airControl: 0.22,
        jumpPower: 8.5, maxCharge: 60, chargeJumpCost: 15,
        staminaDrain: 0.15, staminaRecover: 0.5,
        chalkDrain: 0.12, chalkRefill: 40,
        maxChalk: 100, pineappleBonus: 45,
        restTimeReq: 120 // 2 seconds @ 60fps
    },
    KEYS: { UP: ['arrowup','w'], DOWN: ['arrowdown','s'], LEFT: ['arrowleft','a'], RIGHT: ['arrowright','d'], GRAB: ['z'], JUMP: ['x'], CHARGE: [' '] }
};

const Game = {
    canvas: null, ctx: null,
    state: {
        active: false, startTime: 0,
        cameraY: 0, floor: 0, celebrationTime: 0,
        player: { 
            x: 0, y: 0, w: 24, h: 32, vx: 0, vy: 0, 
            stamina: 100, maxStamina: 100, chalk: 100, 
            isHolding: false, grabLock: false, charge: 0, restTimer: 0 
        },
        inputs: {}, prevInputs: {},
        objects: { grips: [], items: [], texts: [], wind: [], fireworks: [], flag: null },
        wind: { force: 0, timer: 0 }
    },

    init() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();
        window.addEventListener('resize', () => this.resize());
        window.addEventListener('keydown', e => this.handleInput(e, true));
        window.addEventListener('keyup', e => this.handleInput(e, false));
    },

    resize() { this.canvas.width = 400; this.canvas.height = window.innerHeight; },
    handleInput(e, isDown) { const k = e.key.toLowerCase(); this.state.inputs[k] = isDown; if([' '].includes(k)) e.preventDefault(); },
    isPressed(action) { return CONSTANTS.KEYS[action].some(k => this.state.inputs[k]); },
    justPressed(action) { return CONSTANTS.KEYS[action].some(k => this.state.inputs[k] && !this.state.prevInputs[k]); },
    wasPressed(action) { return CONSTANTS.KEYS[action].some(k => !this.state.inputs[k] && this.state.prevInputs[k]); },

    start() {
        this.state.active = true;
        this.state.startTime = Date.now();
        this.state.player.x = 200 - 12; this.state.player.y = 80;
        this.generateLevel();
        document.getElementById('overlay').classList.add('hidden');
        document.getElementById('ui').classList.remove('hidden');
        requestAnimationFrame(t => this.loop(t));
    },

    generateLevel() {
        const { grips, items, texts } = this.state.objects;
        const { SETTINGS } = CONSTANTS;
        let curY = 0, lastX = 200;
        let patternCounter = 0; // ç”¨æ–¼è¨ˆç®— 1ç¶ :Né»ƒ çš„å¾ªç’°

        const addGrip = (x, y, w, h, type, extra = {}) => {
            if (grips.some(g => Math.abs(g.y - y) < 40)) return false;
            grips.push({ x, y, w, h, type, ...extra });
            lastX = x + w/2; return true;
        };

        const getNextX = (w, dev, y) => {
            const widthAtY = (y > 90 * SETTINGS.floorHeight) ? 280 : 400;
            const min = Math.max(200 - widthAtY/2 + 20, lastX - dev - w/2);
            const max = Math.min(200 + widthAtY/2 - w - 20, lastX + dev - w/2);
            return min + Math.random() * (max - min);
        };

        // 1. åœ°åŸº
        addGrip(0, 0, 400, 60, 'REST');
        texts.push({ x: 200, y: 150, text: "1F" });
        texts.push({ x: 200, y: 120, text: "æŒ‰ 'Z' æŠ“æ¡ / 'X' è·³èº / 'SPACE' è“„åŠ›", size: 14 });

        curY = 180;
        const spawnPineapples = (minF, maxF, count) => {
            for(let i=0; i<count; i++) {
                const fy = (minF + Math.random()*(maxF-minF)) * SETTINGS.floorHeight;
                items.push({ x: 0, y: fy, w: 44, h: 44, type: 'PINEAPPLE', active: true, pendingPlace: true });
            }
        };
        spawnPineapples(1, 30, 10); spawnPineapples(30, 60, 8); spawnPineapples(60, 90, 3);

        while (curY < 101 * SETTINGS.floorHeight) {
            const floor = Math.floor(curY / SETTINGS.floorHeight);
            let type = 'NORMAL';
            let w, h, jumpDist, extra = {};

            // æª¢æŸ¥é»ï¼šå¼·åˆ¶å¤§å¹³å° (30, 60, 90F)
            if (floor === 30 || floor === 60 || floor === 90) {
                type = 'REST'; w = 300; h = 40; jumpDist = 200;
                addGrip(50, curY, w, h, type);
                texts.push({ x: 200, y: curY + 60, text: `${floor}F å¤§ä¼‘æ¯å€`, size: 14 });
                curY += jumpDist;
                patternCounter = 0; // é‡ç½®å¾ªç’°
                continue;
            }

            // éšæ®µ 1: 0-20F (æ•™å­¸å€ï¼Œè¼ƒç°¡å–®ï¼Œéš¨æ©Ÿ)
            if (floor < 20) {
                if (curY < 5 * SETTINGS.floorHeight) { // 1-5F è¶…ç°¡å–®
                    type = 'REST'; w = 150 + Math.random()*50; h = 24; jumpDist = 120;
                } else {
                    type = (patternCounter >= 2) ? 'REST' : 'NORMAL';
                    if (type === 'REST') patternCounter = 0; else patternCounter++;
                    w = type === 'REST' ? 150 : 60; h = type === 'REST' ? 24 : 140; jumpDist = 140;
                }
            }
            // éšæ®µ 2: 20-45F (1ç¶  : 3é»ƒ)
            else if (floor < 45) {
                type = (patternCounter >= 3) ? 'REST' : 'NORMAL';
                if (type === 'REST') patternCounter = 0; else patternCounter++;
                w = type === 'REST' ? 120 : 50; h = type === 'REST' ? 24 : 160; jumpDist = 160;
            }
            // éšæ®µ 3: 45-65F (1ç¶  : 4~5é»ƒ)
            else if (floor < 65) {
                const threshold = 4 + Math.floor(Math.random()*2); // 4 or 5
                type = (patternCounter >= threshold) ? 'REST' : 'NORMAL';
                if (type === 'REST') patternCounter = 0; else patternCounter++;
                w = type === 'REST' ? 100 : 40; h = type === 'REST' ? 24 : 180; jumpDist = 180;
                if (type === 'NORMAL' && Math.random() > 0.5) extra = { vx: 1.5, range: 60, startX: 0 };
            }
            // éšæ®µ 4: 65F+ (é«˜é›£åº¦ï¼šç´°é•·é»ƒè‰²ï¼Œç¶ è‰²ç¨€å°‘)
            else {
                // 10% æ©Ÿç‡å‡ºç¾ä¼‘æ¯ï¼Œå¦å‰‡å…¨æ˜¯é»ƒè‰²
                type = (Math.random() < 0.1) ? 'REST' : 'NORMAL'; 
                // é»ƒè‰²è‰²å¡Šå¯¬åº¦æ¥µçª„ (20-30px)
                w = type === 'REST' ? 60 : 20 + Math.random()*10; 
                h = type === 'REST' ? 24 : 200 + Math.random()*100; 
                jumpDist = 200;
                if (type === 'NORMAL') extra = { vx: 2.5, range: 100, startX: 0 };
            }

            let tryX = getNextX(w, 180, curY);
            if (extra.vx) {
                extra.startX = tryX;
                if (tryX - extra.range < 20) extra.startX = 20 + extra.range;
                if (tryX + extra.range + w > 380) extra.startX = 380 - w - extra.range;
            }

            if (addGrip(extra.
