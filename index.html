<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>101 æ”€çˆ¬è€… | æ ¸å¿ƒé‚è¼¯æ ¡æº–ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; margin: 0; overflow: hidden; font-family: sans-serif; }
        #game-container { position: relative; width: 100%; max-width: 400px; height: 100vh; margin: 0 auto; background: #0f172a; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
    </style>
</head>
<body>
<div id="game-container">
    <div id="ui" class="absolute top-4 left-4 z-10 hidden pointer-events-none">
        <div class="bg-slate-900/80 backdrop-blur-md p-4 rounded-xl border border-teal-800/50 w-64 shadow-2xl text-white">
            <div class="flex justify-between items-end mb-1">
                <span class="text-xs font-bold text-teal-400">é«˜åº¦</span>
                <span class="text-2xl font-black"><span id="floor">0</span> <span class="text-sm font-normal text-teal-600">/ 101 F</span></span>
            </div>
            <div class="text-right text-xs font-mono text-teal-400 mb-2 italic" id="timer">00m00s00</div>
            <div class="mt-4 space-y-3">
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-bold text-teal-500"><span>STAMINA</span><span id="stamina-text">100 / 100</span></div>
                    <div class="w-full bg-slate-950 rounded-full h-3 border border-teal-900/50 overflow-hidden"><div id="stamina-bar" class="h-full bg-sky-500" style="width: 100%"></div></div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-bold text-slate-400"><span>CHALK</span><span id="chalk-text">100%</span></div>
                    <div class="w-full bg-slate-950 rounded-full h-2 border border-slate-800 overflow-hidden"><div id="chalk-bar" class="h-full bg-slate-200" style="width: 100%"></div></div>
                </div>
            </div>
        </div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-950/95 z-20 p-8 text-center text-white">
        <div id="start-screen">
            <div class="text-6xl mb-6">ğŸ§—</div>
            <h1 class="text-4xl font-black mb-8 italic">101 CLIMBERS</h1>
            <button onclick="startGame()" class="bg-orange-500 hover:bg-orange-400 text-white px-16 py-5 rounded-2xl font-black text-2xl shadow-xl">é–‹å§‹æ”€ç™»</button>
        </div>
    </div>
</div>

<script>
// --- æ ¸å¿ƒåƒæ•¸ (100% å¼•ç”¨ constants.ts) ---
const COLORS = { SKY_BOTTOM: '#0f172a', SKY_TOP: '#020617', GLASS: '#115e59', MULLION: '#334155', PLAYER: '#38bdf8', GRIP: '#fbbf24', REST: '#22c55e' };
const SETTINGS = { floorHeight: 400, buildingWidth: 400, staminaDrainRate: 0.15, staminaRecoverRate: 0.5, gravity: 0.28, jumpBasePower: 8.5, maxChalk: 100, chalkDrainRate: 0.12, maxCharge: 60, climbSpeed: 4.0, walkSpeed: 4.8, airControl: 0.22 };

// --- éŠæˆ²è®Šæ•¸ ---
let active = false, startTime = 0, cameraY = 0;
let player = { x: 188, y: 80, vx: 0, vy: 0, w: 24, h: 32, stamina: 100, maxS: 100, chalk: 100, isHolding: false, grabLock: false, charge: 0 };
let grips = [], keys = {}, prevKeys = {};

// --- é—œå¡ç”Ÿæˆé‚è¼¯æ ¡æ­£ ---
function generateLevel() {
    grips = []; let curY = 0, lastX = 200, normalGripCount = 0;
    const addGrip = (x, y, w, h, type) => {
        // é˜²æ­¢é‡ç–Šçš„æ ¸å¿ƒåˆ¤å®š
        if (grips.some(g => Math.abs(g.y - y) < 40)) return false; 
        grips.push({ x, y, w, h, type });
        lastX = x + w/2; return true;
    };
    const getNextX = (w, dev) => Math.max(50, Math.min(350 - w, lastX - dev + Math.random() * (dev * 2)));

    addGrip(0, 0, 400, 60, 'REST'); // èµ·å§‹åœ°æ¿
    curY = 180;
    
    // åˆæœŸ (1F-5F)ï¼šç´” REST å¹³å°ï¼Œç„¡é»ƒè‰²è‰²å¡Š
    while(curY < 5 * 400) {
        let w = 150 + Math.random() * 80;
        if (addGrip(getNextX(w, 100), curY, w, 24, 'REST')) curY += 160;
        else curY += 40;
    }
    // 5F-30Fï¼šæ··åˆç”Ÿæˆ
    while(curY < 30 * 400) {
        let type = (normalGripCount >= 3) ? 'REST' : 'NORMAL';
        normalGripCount = (type === 'REST') ? 0 : normalGripCount + 1;
        let w = type === 'REST' ? 120 + Math.random()*60 : 60 + Math.random()*40;
        let h = type === 'REST' ? 24 : 140;
        if (addGrip(getNextX(w, 150), curY, w, h, type)) curY += (type === 'REST' ? 150 : 120);
        else curY += 40;
    }
}

// --- ç‰©ç†èˆ‡æ“ä½œé‚„åŸ ---
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => {
    if (e.key === ' ' && player.charge > 5) executeJump(player.charge);
    keys[e.key.toLowerCase()] = false;
};

function executeJump(c) {
    const powerMult = 1 + (c / SETTINGS.maxCharge) * 1.1;
    player.vy = SETTINGS.jumpBasePower * powerMult;
    player.vx += (keys['arrowleft'] || keys['a'] ? -4.5 : keys['arrowright'] || keys['d'] ? 4.5 : 0);
    player.charge = 0; player.isHolding = false;
    if (keys['z']) player.grabLock = true;
}

function startGame() {
    active = true; generateLevel(); startTime = Date.now();
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('ui').classList.remove('hidden');
    loop();
}

function loop() {
    if (!active) return;
    const canvas = document.getElementById('gameCanvas');
    canvas.width = 400; canvas.height = window.innerHeight;

    // 1. åµæ¸¬ç¢°æ’ (é‚„åŸæ‚¨çš„åˆ¤å®šé‚è¼¯)
    let standingOn = grips.find(g => g.type === 'REST' && player.y <= g.y + g.h && player.y >= g.y + g.h - 15 && player.x + player.w > g.x && player.x < g.x + g.w && player.vy <= 0);
    let currentGrip = grips.find(g => player.x + player.w > g.x && player.x < g.x + g.w && player.y + player.h > g.y && player.y < g.y + g.h);

    if (!keys['z']) player.grabLock = false;

    // 2. åˆ†æ”¯ç‹€æ…‹è™•ç†
    if (keys['z'] && currentGrip && !player.grabLock && player.stamina > 0) {
        player.isHolding = true; player.vy = 0; player.vx = 0;
        player.stamina -= SETTINGS.staminaDrainRate;
        player.chalk = Math.max(0, player.chalk - SETTINGS.chalkDrainRate);
        if (keys['arrowup'] || keys['w']) player.y += SETTINGS.climbSpeed;
        if (keys['arrowdown'] || keys['s']) player.y -= SETTINGS.climbSpeed;
        if (keys['arrowleft'] || keys['a']) player.x -= SETTINGS.climbSpeed;
        if (keys['arrowright'] || keys['d']) player.x += SETTINGS.climbSpeed;
        if (keys['x'] && !prevKeys['x']) executeJump(0);
    } else if (standingOn) {
        player.isHolding = false; player.vy = 0; player.y = standingOn.y + standingOn.h;
        player.vx *= 0.85;
        player.stamina = Math.min(100, player.stamina + SETTINGS.staminaRecoverRate);
        if (keys['arrowleft'] || keys['a']) player.x -= SETTINGS.walkSpeed;
        if (keys['arrowright'] || keys['d']) player.x += SETTINGS.walkSpeed;
        if (keys['x'] && !prevKeys['x']) executeJump(0);
    } else {
        player.isHolding = false; player.vy -= SETTINGS.gravity; player.y += player.vy; player.x += player.vx;
        if (keys['arrowleft'] || keys['a']) player.vx -= SETTINGS.airControl;
        if (keys['arrowright'] || keys['d']) player.vx += SETTINGS.airControl;
        player.vx *= 0.97;
    }

    if (keys[' ']) player.charge = Math.min(SETTINGS.maxCharge, player.charge + 1.5);
    
    // 3. UI æ›´æ–°èˆ‡æ¸²æŸ“
    document.getElementById('stamina-bar').style.width = player.stamina + '%';
    document.getElementById('chalk-bar').style.width = player.chalk + '%';
    document.getElementById('floor').innerText = Math.floor(player.y / 400);

    render();
    prevKeys = {...keys};
    cameraY += (player.y - 300 - cameraY) * 0.12;
    requestAnimationFrame(loop);
}

function render() {
    const ctx = document.getElementById('gameCanvas').getContext('2d');
    ctx.fillStyle = COLORS.SKY_TOP; ctx.fillRect(0,0,400,window.innerHeight);
    
    ctx.save(); ctx.translate(0, window.innerHeight); ctx.scale(1, -1); ctx.translate(0, -cameraY);

    // ç•« 101 èƒŒæ™¯
    ctx.strokeStyle = COLORS.MULLION; ctx.globalAlpha = 0.3;
    for(let y=0; y < 101*400; y+=40) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(400, y); ctx.stroke(); }

    // ç•«è¸æ¿
    grips.forEach(g => {
        ctx.fillStyle = g.type === 'REST' ? COLORS.REST : COLORS.GRIP;
        ctx.globalAlpha = 1; ctx.fillRect(g.x, g.y, g.w, g.h);
    });

    // ç•«ç©å®¶èˆ‡ç¸®æ”¾å‹•ç•«
    const squash = player.charge / SETTINGS.maxCharge;
    const dW = player.w * (1 + squash * 0.3), dH = player.h * (1 - squash * 0.4);
    ctx.fillStyle = COLORS.PLAYER; ctx.fillRect(player.x - (dW-player.w)/2, player.y, dW, dH);
    
    ctx.restore();
}
</script>
</body>
</html>
