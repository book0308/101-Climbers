<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>101 æ”€çˆ¬è€… | ç‰©ç†èˆ‡å‹•ç•«é‚„åŸç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #020617; margin: 0; overflow: hidden; font-family: sans-serif; }
        #game-container { position: relative; width: 100%; max-width: 400px; height: 100vh; margin: 0 auto; background: #0f172a; }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui" class="absolute top-4 left-4 z-10 hidden pointer-events-none">
        <div class="bg-slate-900/80 backdrop-blur-md p-4 rounded-xl border border-teal-800/50 w-64 shadow-2xl">
            <div class="flex justify-between items-end mb-1">
                <span class="text-xs font-bold text-teal-400 uppercase">é«˜åº¦ <span id="god-label"></span></span>
                <span class="text-2xl font-black text-white"><span id="floor">0</span> <span class="text-sm font-normal text-teal-600">/ 101 F</span></span>
            </div>
            <div class="text-right text-xs font-mono text-teal-400 mb-2 italic" id="timer">00m00s00</div>
            <div class="mt-4 space-y-3">
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-bold text-teal-500"><span>STAMINA</span><span id="stamina-text">100 / 100</span></div>
                    <div class="w-full bg-slate-950 rounded-full h-3 border border-teal-900/50 overflow-hidden"><div id="stamina-bar" class="h-full bg-sky-500" style="width: 100%"></div></div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-bold text-slate-400"><span>CHALK</span><span id="chalk-text">100%</span></div>
                    <div class="w-full bg-slate-950 rounded-full h-2 border border-slate-800 overflow-hidden"><div id="chalk-bar" class="h-full bg-slate-200" style="width: 100%"></div></div>
                </div>
            </div>
        </div>
    </div>
    <canvas id="gameCanvas"></canvas>
    <div id="overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-950/95 z-20 p-8 text-center">
        <div id="start-screen">
            <div class="text-6xl mb-6">ğŸ§—</div>
            <h1 class="text-5xl font-black mb-10 italic text-transparent bg-clip-text bg-gradient-to-br from-teal-300 to-sky-500">101 CLIMBERS</h1>
            <button onclick="startGame()" class="bg-orange-500 hover:bg-orange-400 text-white px-16 py-5 rounded-2xl font-black text-2xl shadow-xl">é–‹å§‹æ”€ç™»</button>
        </div>
    </div>
</div>

<script>
/** æ ¸å¿ƒå¸¸æ•¸èˆ‡é…ç½® **/
const COLORS = { SKY_BOTTOM: '#0f172a', SKY_TOP: '#020617', GLASS: '#115e59', MULLION: '#334155', PLAYER: '#38bdf8', GRIP: '#fbbf24', REST: '#22c55e', WIND: 'rgba(255, 255, 255, 0.25)' };
const SETTINGS = { floorHeight: 400, buildingWidth: 400, staminaDrainRate: 0.15, staminaRecoverRate: 0.5, gravity: 0.28, jumpBasePower: 8.5, maxChalk: 100, chalkDrainRate: 0.12, maxCharge: 60, walkSpeed: 4.8, airControl: 0.22, climbSpeed: 4.0 };
const KEY_MAP = { GRAB: ['z'], JUMP: ['x'], CHARGE: [' '], UP: ['arrowup','w'], DOWN: ['arrowdown','s'], LEFT: ['arrowleft','a'], RIGHT: ['arrowright','d'] };

/** éŠæˆ²ç‹€æ…‹ **/
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
let active = false, startTime = 0, cameraY = 0;
let player = { x: 188, y: 50, vx: 0, vy: 0, width: 24, height: 32, stamina: 100, maxStamina: 100, chalk: 100, isHolding: false, grabLock: false, charge: 0 };
let grips = [], worldTexts = [], keys = {}, prevKeys = {};

/** ç‰©ç†è¼”åŠ©åŠŸèƒ½ **/
const getBuildingWidthAtY = (y) => (y/400 < 90) ? 400 : 400 * (1 - Math.min(1, (y/400-90)/11)*0.7);

/** é—œå¡ç”Ÿæˆ (é‚„åŸæ‚¨çš„ generateLevel) **/
function generateLevel() {
    grips = []; worldTexts = []; let curY = 0, lastX = 200, normalGripCount = 0;
    const addGrip = (x, y, w, h, type) => { grips.push({ x, y, width: w, height: h, type }); lastX = x + w/2; };
    const getNextX = (w, dev, y) => {
        const bW = getBuildingWidthAtY(y);
        const minX = Math.max(200 - bW/2 + 30, lastX - dev - w/2);
        const maxX = Math.min(200 + bW/2 - w - 30, lastX + dev - w/2);
        return minX + Math.random() * (maxX - minX);
    };

    addGrip(0, 0, 400, 60, 'REST');
    worldTexts.push({ x: 20, y: 420, text: "1F: [X]è·³èº [Z]æŠ“æ¡ [ç©ºç™½]è“„åŠ›" });
    
    curY = 120;
    while(curY < 30 * 400) { // é‚„åŸæ‚¨çš„åˆæœŸå¯†é›†è¸æ¿é‚è¼¯
        let type = (normalGripCount >= 3) ? 'REST' : 'NORMAL';
        normalGripCount = (type === 'REST') ? 0 : normalGripCount + 1;
        let w = type === 'REST' ? 120 + Math.random()*60 : 60 + Math.random()*40;
        let h = type === 'REST' ? 24 : 140 + Math.random()*60;
        // é—œéµï¼šé‚„åŸæ‚¨çš„ curY å¢é‡é‚è¼¯ï¼Œè§£æ±ºé–“è·éå¤§å•é¡Œ
        if (addGrip(getNextX(w, 150, curY), curY, w, h, type)) curY += (type === 'REST' ? 120 : h - 20);
        else curY += 40;
    }
}

/** æ ¸å¿ƒç‰©ç†ç³»çµ± (é‚„åŸæ‚¨çš„ update é‚è¼¯) **/
function executeJump(c, isCharge) {
    const powerMult = 1 + (c / SETTINGS.maxCharge) * 1.1;
    player.vy = SETTINGS.jumpBasePower * powerMult;
    // é‚„åŸè·³èºæ™‚çš„æ…£æ€§åç§»
    player.vx += (keys['arrowleft'] || keys['a'] ? -4.5 : keys['arrowright'] || keys['d'] ? 4.5 : 0);
    player.charge = 0; player.isHolding = false;
    if (keys['z']) player.grabLock = true;
}

window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => {
    if (e.key === ' ' && player.charge > 5) executeJump(player.charge, true);
    keys[e.key.toLowerCase()] = false;
};

function startGame() {
    active = true; generateLevel(); startTime = Date.now();
    document.getElementById('overlay').classList.add('hidden');
    document.getElementById('ui').classList.remove('hidden');
    canvas.width = 400; canvas.height = window.innerHeight;
    loop();
}

function loop() {
    if (!active) return;
    
    // ç¢°æ’åµæ¸¬
    let standingOn = grips.find(g => g.type === 'REST' && player.y >= g.y + g.height && player.y <= g.y + g.height + 15 && player.x + player.width > g.x && player.x < g.x + g.width && player.vy <= 0);
    let currentGrip = grips.find(g => player.x + player.width > g.x && player.x < g.x + g.width && player.y + player.height > g.y && player.y < g.y + g.height);

    if (!keys['z']) player.grabLock = false;

    // é‚„åŸæ‚¨çš„æ“ä½œåˆ†æ”¯é‚è¼¯
    if (keys['z'] && currentGrip && !player.grabLock && player.stamina > 0) {
        player.isHolding = true; player.vy = 0; player.vx = 0;
        player.stamina -= SETTINGS.staminaDrainRate;
        player.chalk = Math.max(0, player.chalk - SETTINGS.chalkDrainRate);
        if (keys['arrowup'] || keys['w']) player.y += SETTINGS.climbSpeed;
        if (keys['arrowdown'] || keys['s']) player.y -= SETTINGS.climbSpeed;
        if (keys['arrowleft'] || keys['a']) player.x -= SETTINGS.climbSpeed;
        if (keys['arrowright'] || keys['d']) player.x += SETTINGS.climbSpeed;
        if (keys['x']) executeJump(0, false);
    } else if (standingOn) {
        player.isHolding = false; player.vy = 0; player.y = standingOn.y + standingOn.height;
        player.vx *= 0.85; // æ‘©æ“¦åŠ›
        player.stamina = Math.min(100, player.stamina + SETTINGS.staminaRecoverRate);
        if (keys['arrowleft'] || keys['a']) player.x -= SETTINGS.walkSpeed;
        if (keys['arrowright'] || keys['d']) player.x += SETTINGS.walkSpeed;
        if (keys['x']) executeJump(0, false);
    } else {
        player.isHolding = false; player.vy -= SETTINGS.gravity; player.y += player.vy; player.x += player.vx;
        if (keys['arrowleft'] || keys['a']) player.vx -= SETTINGS.airControl;
        if (keys['arrowright'] || keys['d']) player.vx += SETTINGS.airControl;
        player.vx *= 0.97; // ç©ºæ°£é˜»åŠ›
    }

    if (keys[' ']) player.charge = Math.min(SETTINGS.maxCharge, player.charge + 1.5);

    // æ›´æ–°ä»‹é¢
    const ms = Date.now() - startTime;
    document.getElementById('timer').innerText = `${String(Math.floor(ms/60000)).padStart(2,'0')}m${String(Math.floor((ms%60000)/1000)).padStart(2,'0')}s${String(Math.floor((ms%1000)/10)).padStart(2,'0')}`;
    document.getElementById('stamina-bar').style.width = player.stamina + '%';
    document.getElementById('chalk-bar').style.width = player.chalk + '%';
    document.getElementById('floor').innerText = Math.floor(player.y / 400);

    draw();
    cameraY += (player.y - 300 - cameraY) * 0.12;
    requestAnimationFrame(loop);
}

/** ç¹ªåœ–ç³»çµ± (é‚„åŸæ‚¨çš„æ–¹å¡Šå£“ç¸®èˆ‡æ¸²æŸ“é‚è¼¯) **/
function draw() {
    ctx.fillStyle = COLORS.SKY_TOP; ctx.fillRect(0,0,400,canvas.height);
    ctx.save(); ctx.translate(0, canvas.height); ctx.scale(1, -1); ctx.translate(0, -cameraY);

    // é—œå¡èˆ‡æ–‡å­—
    grips.forEach(g => { ctx.fillStyle = g.type === 'REST' ? COLORS.REST : COLORS.GRIP; ctx.fillRect(g.x, g.y, g.width, g.height); });
    worldTexts.forEach(t => { ctx.save(); ctx.scale(1,-1); ctx.fillStyle="#fff"; ctx.font="14px Arial"; ctx.fillText(t.text, t.x, -t.y); ctx.restore(); });

    // é‚„åŸæ‚¨çš„æ–¹å¡Šå£“ç¸®å‹•ç•«é‚è¼¯
    const squash = player.charge / SETTINGS.maxCharge;
    const dW = player.width * (1 + squash * 0.3);
    const dH = player.height * (1 - squash * 0.4);
    const offX = (dW - player.width) / 2;

    ctx.fillStyle = COLORS.PLAYER;
    ctx.fillRect(player.x - offX, player.y, dW, dH);
    
    // è“„åŠ›æ¢
    if (player.charge > 2) {
        ctx.fillStyle = player.charge >= SETTINGS.maxCharge ? '#ef4444' : '#fff';
        ctx.fillRect(player.x, player.y - 15, (player.width * squash), 4);
    }
    ctx.restore();
}
</script>
</body>
</html>
